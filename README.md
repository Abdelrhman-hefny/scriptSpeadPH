# testScript — سكربتات فوتوشوب لمعالجة نصوص المانجا

## نظرة عامة

هذا المشروع ي automatisate إدراج نصوص المانجا داخل فقاعات الكلام في ملفات PSD، مع ميزات:

- قراءة نص من `manga_text.txt` مع دعم تقسيم الصفحات والكلمات المفتاحية للخطوط والوسوم.
- مطابقة كل سطر نصي مع مسارات الفقاعات داخل كل صفحة (Path → Selection → Text Layer).
- ضبط حجم وموقع النص، والتوسيط الذكي مع مراعاة ذيل الفقاعة.
- تشكيل الأسطر تلقائياً داخل الفقاعة لتبدو أقصر في الأعلى والأسفل وأعرض في الوسط.
- أنماط تشغيل متعددة: سريع، سريع جداً، وإيقاف بعد الصفحة الأولى للمراجعة.
- دعم فتح عدة ملفات PSD من قائمة روابط قبل المعالجة عبر `links.txt`.

## هيكل المجلدات

```
testScript/
├─ scripts/
│  ├─ scriptSPead.jsx              # السكربت الرئيسي
│  ├─ convirtToWeb.JSX             # سكربت مساعد (تحويل للويب)
│  └─ ...                          # سكربتات أخرى مساعدة
├─ lib/
│  ├─ psHelpers.jsx                # دوال مساعدة عامة (trim/toNum/…)
│  ├─ textReader.jsx               # قراءة ملف النص وتحديد بدايات الصفحات
│  ├─ teamLoader.jsx               # تحميل فرق/إعدادات الخطوط من JSON
│  ├─ splitSubpaths.jsx            # تقسيم Work Path إلى مسارات مسماة
│  ├─ fileUtils.jsx                # كتابة اللوج
│  ├─ colorUtils.jsx               # أخذ عينات ألوان وتقدير السطوع
│  ├─ textFX.jsx                   # تأثيرات نص اختيارية
│  ├─ textUtils.jsx                # أدوات نصوص عامة
│  └─ bubble_text_centering_solution.jsx  # توسيط محسّن مع الذيل
├─ config/
│  ├─ teams.json                   # فرق وخريطة الخطوط وخيارات الصندوق
│  └─ json2.js
├─ manga_text.txt                  # ملف النص الأساسي (ينشئ تلقائياً أول مرة)
├─ links.txt                       # (اختياري) قائمة ملفات PSD للعمل عليها
├─ links_resolved.txt              # ناتج معالجة الروابط (إن وُجد)
└─ README.md
```

## المتطلبات

- Adobe Photoshop (Windows؛ يعمل ExtendScript/JSX).
- تثبيت خطوطك المطلوبة. السكربت يختار بدائل آمنة إذا غاب الخط.

## بدء سريع

1. افتح Photoshop.
2. من File → Scripts → Browse واختر `scripts/scriptSPead.jsx`.
3. سيفتح نافذة إعدادات:
   - اختيار الفريق (من `config/teams.json`).
   - حجم الخط الأساسي.
   - وضع السرعة القصوى/العادي.
   - خيار التوقف بعد الصفحة الحالية للمراجعة.
4. عند التشغيل لأول مرة سيُفتح/يُنشأ `manga_text.txt` تلقائياً. ضع النص كما هو موضح أدناه.
5. جهّز ملفات PSD مفتوحة، أو استخدم `links.txt` لفتح مجموعة ملفات تلقائياً ثم يبدأ الإدراج.

## تنسيق ملف النص `manga_text.txt`

- يمكن تحديد بدايات الصفحات بسطور مثل: `page 1`, `page 2`, …
- كل سطر لاحق يمثل فقاعة واحدة بالترتيب.
- وسوم مدعومة في بداية السطر:
  - `SFX:` أو `ST:` أو `**:` أو `NA:` أو `#` → تفعيل Stroke/خصائص خاصة (بحسب الإعدادات).
  - `[]:` → أسلوب خاص للأوامر/التعليقات داخل الفقاعة (Bold + AllCaps… عند التفعيل).
  - `OT:` أو `Ot:` → تحويل النص إلى AllCaps.
  - `//:` → يرث خط الفقاعة السابقة.
- خريطة الخطوط: يمكنك كتابة مفتاح في بداية السطر يطابق مفاتيح `fontMap` لدى الفريق (انظر `config/teams.json`). إذا طابق المفتاح، يُستخدم الخط المقابل ويُزال المفتاح من النص.

مثال مبسّط:

```
page 1
MainFont Hello there!
ST: Action line
[]: SYSTEM MESSAGE
//: continues with previous font
page 2
OT: SHOUTING LINE
```

## كيف تُوضع الأسطر داخل الفقاعة

- السكربت يختار مسارات الصفحة بالتسلسل الذكي (`getSmartPathsForPage`) ويطابقها بأسطر النص.
- لكل فقاعة:
  - تُحوّل المسار إلى تحديد Selection ثم تُنشأ طبقة نص فقرة Paragraph.
  - يطبّق الخط والحجم بناءً على الفريق والمفاتيح والوسوم.
  - يُحسَب صندوق الكتابة وفق مساحة المسار مع هامش من إعدادات الفريق.
  - تُستدعى دالة تشكيل النص كي يبدو الشكل عدسيّاً: أسطر أقصر أعلى/أسفل وأعرض بالوسط.
  - يُستخدم توسيط TyperTools مع مراعاة ذيل الفقاعة، أو توسيط بديل عند الحاجة.
  - يمكن تلوين النص أبيض/أسود تبعاً لسطوع الخلفية، وتطبيق Stroke عند الوسوم.

### تشكيل النص داخل الفقاعة

يُحقن السكربت فواصل أسطر يدوياً وفق مساحة الصندوق وحجم الخط عبر الدالة:

- تقيس طول النص تقديرياً (متوسط عرض الحرف ≈ 0.6 × حجم الخط) وتحدد عدد أسطر مناسب للصندوق.
- تبني نسب عرض هرمية من 60% عند الحواف إلى 100% في الوسط.
- تلفّ الكلمات لتحقيق الهدف في كل سطر مع الحفاظ على الكلمات الطويلة كسطر مستقل عند الحاجة.

> يمكن تعديل سلوك التدرّج بسهولة: تغيير الحدين 0.6/1.0 أو أقصى عدد أسطر.

## الروابط المتعددة `links.txt`

- إن وُجد `links_resolved.txt` في الجذر فسيستخدمه السكربت أولاً، وإلا يقرأ `links.txt`.
- كل سطر مسار ملف PSD؛ تُتجاهل السطور الفارغة وما يبدأ بـ `#`.
- مسارات نسبية تُفسَّر نسبةً إلى مجلد المشروع.
- عند القراءة تُفتح هذه الملفات بالتسلسل قبل بدء المطابقة والإدراج.

مثال:

```
# مطلق
D:/manga/001.psd
D:/manga/002.psd
# نسبي للمشروع
psds/003.psd
psds/004.psd
```

> ملاحظة: إذا رغبت في دعم HTTP/HTTPS وتنزيل الملفات تلقائياً، أضف سكربت تجهيز خارجي يكتب المسارات المحلية إلى `links_resolved.txt` ثم شغّل السكربت الرئيسي.

## نافذة الإعدادات (الخلاصة)

- Team: يحدد `defaultFont` و`minFontSize` و`boxPaddingRatio` و`fontMap`.
- Base font size: حجم أساس لكل الفقاعات، مع تعديلات طفيفة حسب الوسوم والفريق.
- Ultra Fast / Fast Mode: يقلل التأثيرات واللوج لتسريع التنفيذ.
- Stop after first page: يفيد للمراجعة السريعة.
- Open PS v21 after finish: خيار إضافي لبيئات معينة.

## اللوج والنتائج

- يُكتب لوج مفصّل إلى `photoshop_text_log_verbose.txt` عند تعطيل Ultra Fast.
- في Ultra Fast تُكتب الأخطاء فقط إلى `photoshop_text_errors.txt`.
- تُحفظ المستندات تلقائياً إن لم تكن محفوظة.

## ضبط الفرق `config/teams.json`

- مثال الحقول لكل فريق:
  - `defaultFont`: الخط الافتراضي.
  - `minFontSize`: حد أدنى مقترح (يُضبط عند اللزوم).
  - `boxPaddingRatio`: نسبة الهامش داخل المسار.
  - `fontMap`: مفاتيح → أسماء خطوط. يمكن وضع عدة مفاتيح مفصولة بـ `|`.

## نصائح وحلول المشاكل

- الخط مفقود: سيحاول السكربت استخدام بديل. عدّل `fontMap` أو ثبّت الخط المطلوب.
- ترتيب خاطئ للفقاعات: تأكد من أن مسارات الصفحة مقسومة ومُرتبة. استخدم `splitWorkPathIntoNamedPaths` إن لزم.
- النص غير متوسّط جيداً: جرّب تعطيل Ultra Fast لتفعيل توسيط TyperTools الكامل.
- التفاف غير مرضٍ: عدّل حجم الخط الأساسي أو غيّر نسب تشكيل النص داخل الكود.
- لم تُفتح ملفات: تحقق من صحة المسارات في `links.txt` أو اكتب مسارات مطلقة.

## تطوير وتخصيص

- جميع الدوال المساعدة موجودة تحت `lib/` ويمكن تعديلها دون لمس منطق المعالجة الأساسي.
- يفضَّل إبقاء التعديلات الخاصة بالفرق داخل `teams.json` (الخطوط، الهوامش،…).

---

- المطوّر: abderhman20
- آخر تحديث: 2025-09-23
